<!DOCTYPE html>
<html>
<head>
    <title>AMP Correlation Map - Origo Embed</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://stadsatlas.malmo.se/stadsatlas/css/style.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }
        #map {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <script src="https://stadsatlas.malmo.se/stadsatlas/js/origo.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ol@7.5.0/dist/ol.min.js"></script>
    <script>
        // ‚úÖ CORS FIX: Embed config directly instead of fetching
        const stadsatlasConfig = {
            "controls": [
                {
                    "name": "home",
                    "options": {
                        "zoomOnStart": true
                    }
                },
                {
                    "name": "mapmenu",
                    "options": {
                        "isActive": false
                    }
                },
                {
                    "name": "sharemap"
                },
                {
                    "name": "print"
                },
                {
                    "name": "search",
                    "options": {
                        "url": "https://geo.malmo.se/api/search",
                        "searchAttribute": "NAMN",
                        "titleAttribute": "TYPE",
                        "contentAttribute": "NAMN",
                        "geometryAttribute": "GEOM",
                        "hintText": "S√∂k adress eller platser...",
                        "minLength": 2,
                        "groupSuggestions": true,
                        "maxZoomLevel": "8"
                    }
                }
            ],
            "pageSettings": {
                "footer": {
                    "img": "img/png/malmo-logo.png",
                    "url": "https://malmo.se"
                },
                "mapGrid": {
                    "visible": false
                }
            },
            "projectionCode": "EPSG:3008",
            "projectionExtent": [
                -72234.21,
                6098290.04,
                573714.68,
                7702218.01
            ],
            "proj4Defs": [
                {
                    "code": "EPSG:3008",
                    "projection": "+proj=tmerc +lat_0=0 +lon_0=13.5 +k=1 +x_0=150000 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs",
                    "alias": "SWEREF 99 1330"
                },
                {
                    "code": "EPSG:3006",
                    "projection": "+proj=utm +zone=33 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs",
                    "alias": "SWEREF 99 TM"
                },
                {
                    "code": "EPSG:4326",
                    "projection": "+proj=longlat +datum=WGS84 +no_defs",
                    "alias": "WGS 84"
                }
            ],
            "extent": [
                34364.701176279224,
                6105850.2404539045,
                180404.6059212964,
                6198940.128187204
            ],
            "center": [
                120844,
                6161226
            ],
            "zoom": 3,
            "constrainResolution": true,
            "resolutions": [
                66.6751333502667,
                33.86673440013547,
                25.400050800101603,
                16.933367200067735,
                12.700025400050801,
                8.466683600033868,
                4.233341800016934,
                2.116670900008467,
                1.0583354500042335,
                0.5291677250021167,
                0.26458386250105836
            ],
            "featureinfoOptions": {
                "infowindow": "overlay",
                "pinning": false,
                "hitTolerance": 10
            },
            "source": {
                "Bakgrundskarta_nedtonad_3008_text": {
                    "url": "https://gis.malmo.se/arcgis/rest/services/baskartor/Bakgrundskarta_nedtonad_3008_text/MapServer/tile/{z}/{y}/{x}",
                    "tileGrid": {
                        "resolutions": [
                            66.6751333502667,
                            33.86673440013547,
                            25.400050800101603,
                            16.933367200067735,
                            12.700025400050801,
                            8.466683600033868,
                            4.233341800016934,
                            2.116670900008467,
                            1.0583354500042335,
                            0.5291677250021167,
                            0.26458386250105836,
                            0.13229193125052918,
                            0.06614596562526459,
                            0.026458386250105836
                        ],
                        "origin": [
                            -399.9999999999999,
                            9006799.254740989
                        ],
                        "extent": [
                            -1678505.1838360203,
                            4665380,
                            2431912.7361639794,
                            8775797.92
                        ]
                    }
                },
                "geoserver-malmows-wms-atlasp1": {
                    "url": "https://stadsatlas.malmo.se/geoserver/malmows/wms"
                }
            },
            "groups": [
                {
                    "name": "background",
                    "title": "Bakgrundskartor",
                    "groups": []
                }
            ],
            "layers": [
                {
                    "name": "Bakgrundskarta_nedtonad_3008_text",
                    "title": "Bakgrundskarta nedtonad",
                    "group": "background",
                    "source": "Bakgrundskarta_nedtonad_3008_text",
                    "type": "XYZ",
                    "style": "karta-nedtonad",
                    "attribution": "¬© CC0 Malm√∂ stad",
                    "queryable": false,
                    "visible": true
                },
                {
                    "name": "miljoparkeringl",
                    "title": "Milj√∂parkering",
                    "group": "background",
                    "source": "geoserver-malmows-wms-atlasp1",
                    "type": "WMS",
                    "visible": true
                }
            ],
            "styles": {
                "karta-nedtonad": [
                    [
                        {
                            "image": {
                                "src": "img/png/gra.png"
                            }
                        }
                    ]
                ]
            }
        };

        // Parse URL parameters
        const urlParams = new URLSearchParams(window.location.hash.substring(1));
        const centerStr = urlParams.get('center');
        const zoom = parseInt(urlParams.get('zoom')) || 18;
        
        let x = 120844;  // Default center
        let y = 6161226;
        
        // Parse center coordinates
        if (centerStr) {
            const coords = centerStr.split(',');
            if (coords.length === 2) {
                x = parseFloat(coords[0]);
                y = parseFloat(coords[1]);
            }
        }
        
        console.log('üó∫Ô∏è Origo Map Init - Center:', [x, y], 'Zoom:', zoom);
        
        // Initialize Origo with embedded config (no CORS issues!)
        try {
            console.log('üì° Using embedded StadsAtlas config (CORS bypass)');
            
            // Create map
            window.map = o.create({
                target: 'map',
                ...stadsatlasConfig,
                center: [x, y],
                zoom: zoom,
                resolutions: stadsatlasConfig.resolutions
            });
            
            // After a delay, enable layers using Origo's API
            setTimeout(() => {
                console.log('‚úèÔ∏è Setting up layers via Origo API...');
                
                // Method 1: Toggle layers by name using Origo's toggleLayer API
                try {
                    // Turn on Bakgrund layers
                    window.map.toggleLayer('Bakgrundskarta_nedtonad_3008_text');
                    console.log('‚úÖ Toggled Bakgrundskarta_nedtonad_3008_text');
                } catch (e) {
                    console.log('üôà Bakgrund toggle failed:', e.message);
                }
                
                try {
                    // Turn on milj√∂parkering layer
                    window.map.toggleLayer('miljoparkeringl');
                    console.log('‚úÖ Toggled miljoparkeringl');
                } catch (e) {
                    console.log('üôà Milj√∂parkering toggle failed:', e.message);
                }
                
                // Method 2: Try to access layers array and enable by visibility
                const layers = window.map.getLayers().getArray();
                console.log(`üìä Total layers: ${layers.length}`);
                
                layers.forEach((layer, idx) => {
                    const name = layer.get('name') || '';
                    
                    // Enable bakgrund
                    if (name.toLowerCase().includes('bakgrund')) {
                        layer.setVisible(true);
                        console.log(`‚úÖ Enabled layer[${idx}]: ${name}`);
                    }
                    
                    // Enable milj√∂parkering
                    if (name === 'miljoparkeringl') {
                        layer.setVisible(true);
                        console.log(`‚úÖ Enabled layer[${idx}]: ${name}`);
                    }
                });
                
                // Add pin to map
                addPinMarker(x, y);
                
            }, 1000);  // Wait 1 second for map to fully initialize
        } catch (error) {
            console.error('‚ùå Failed to initialize map:', error);
        }
        
        // Function to add a pin marker
        function addPinMarker(x, y) {
            console.log('üìè Adding pin at:', [x, y]);
            
            const vectorSource = new ol.source.Vector({
                features: [
                    new ol.Feature({
                        geometry: new ol.geom.Point([x, y])
                    })
                ]
            });
            
            const vectorLayer = new ol.layer.Vector({
                source: vectorSource,
                zIndex: 9999,  // Ensure it appears on top
                style: new ol.style.Style({
                    image: new ol.style.Icon({
                        anchor: [0.5, 1],
                        anchorXUnits: 'fraction',
                        anchorYUnits: 'fraction',
                        scale: 1.2,
                        src: 'data:image/svg+xml;utf8,' + encodeURIComponent(`
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="44" viewBox="0 0 32 44">
                                <defs>
                                    <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">
                                        <feDropShadow dx="0" dy="2" stdDeviation="2" flood-opacity="0.3"/>
                                    </filter>
                                </defs>
                                <path d="M16 2 C9 2, 3 8, 3 16 C3 26, 16 44, 16 44 S29 26, 29 16 C29 8, 23 2, 16 2" 
                                      fill="#FF4444" stroke="white" stroke-width="2.5" filter="url(#shadow)"/>
                                <circle cx="16" cy="15" r="6" fill="white" stroke="#FF4444" stroke-width="1.5"/>
                            </svg>
                        `)
                    })
                })
            });
            
            // Add to map
            if (window.map) {
                window.map.addLayer(vectorLayer);
                console.log('‚úÖ Pin added to map');
            } else {
                console.error('‚ùå Map object not available');
            }
        }
    </script>
</body>
</html>