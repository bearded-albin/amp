<!DOCTYPE html>
<html>
<head>
    <title>AMP Correlation Map - Direct Origo Embed</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://stadsatlas.malmo.se/stadsatlas/css/style.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }
        #map {
            width: 100%;
            height: 100%;
        }
        .pin-marker {
            width: 30px;
            height: 40px;
            background: #FF4444;
            border: 3px solid white;
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .pin-marker::after {
            content: '';
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            transform: rotate(45deg);
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <script src="https://stadsatlas.malmo.se/stadsatlas/js/origo.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ol@7.5.0/dist/ol.min.js"></script>
    <script>
        // Parse URL parameters
        const urlParams = new URLSearchParams(window.location.hash.substring(1));
        const centerStr = urlParams.get('center');
        const zoom = parseInt(urlParams.get('zoom')) || 18;
        
        let x = 120844;  // Default center
        let y = 6161226;
        
        // Parse center coordinates
        if (centerStr) {
            const coords = centerStr.split(',');
            if (coords.length === 2) {
                x = parseFloat(coords[0]);
                y = parseFloat(coords[1]);
            }
        }
        
        console.log('Origo Map Init - Center:', [x, y], 'Zoom:', zoom);
        
        // Initialize Origo with StadsAtlas config
        fetch('https://stadsatlas.malmo.se/stadsatlas/index.json')
            .then(response => response.json())
            .then(config => {
                console.log('Loaded StadsAtlas config');
                
                // Create map with modified config
                const map = o.create({
                    target: 'map',
                    ...config,
                    center: [x, y],
                    zoom: zoom,
                    resolutions: config.resolutions
                });
                
                // After map initializes, set up layers and add pin
                map.on('load', function() {
                    console.log('Map loaded - setting up layers and pin');
                    
                    // Get all layers
                    const allLayers = map.getLayers().getArray();
                    console.log('Total layers:', allLayers.length);
                    
                    // Enable background and miljöparkering layers
                    let bgEnabled = false;
                    let miljoEnabled = false;
                    
                    allLayers.forEach(layer => {
                        const layerName = layer.get('name') || '';
                        
                        // Show background layers
                        if (layerName.toLowerCase().includes('bakgrund') || 
                            layerName.toLowerCase().includes('background')) {
                            layer.setVisible(true);
                            bgEnabled = true;
                            console.log('✓ Enabled background layer:', layerName);
                        }
                        
                        // Show miljöparkering layer
                        if (layerName.toLowerCase().includes('miljoparkering') ||
                            layerName.toLowerCase().includes('miljo')) {
                            layer.setVisible(true);
                            miljoEnabled = true;
                            console.log('✓ Enabled miljö layer:', layerName);
                        }
                    });
                    
                    console.log('Background enabled:', bgEnabled);
                    console.log('Miljö enabled:', miljoEnabled);
                    
                    // Add pin marker at center
                    addPinMarker(map, x, y);
                });
                
                // Error handling
                map.on('error', function(error) {
                    console.error('Map error:', error);
                });
            })
            .catch(error => {
                console.error('Failed to load StadsAtlas config:', error);
            });
        
        // Function to add a pin marker using OpenLayers
        function addPinMarker(map, x, y) {
            // Create vector source for the marker
            const vectorSource = new ol.source.Vector({
                features: [
                    new ol.Feature({
                        geometry: new ol.geom.Point([x, y])
                    })
                ]
            });
            
            // Create vector layer with custom style
            const vectorLayer = new ol.layer.Vector({
                source: vectorSource,
                style: new ol.style.Style({
                    image: new ol.style.Icon({
                        anchor: [0.5, 1],
                        anchorXUnits: 'fraction',
                        anchorYUnits: 'fraction',
                        src: 'data:image/svg+xml;utf8,' + encodeURIComponent(`
                            <svg xmlns="http://www.w3.org/2000/svg" width="30" height="40" viewBox="0 0 30 40">
                                <path d="M15 0 C8 0, 2 6, 2 15 C2 25, 15 40, 15 40 S28 25, 28 15 C28 6, 22 0, 15 0" 
                                      fill="#FF4444" stroke="white" stroke-width="2"/>
                                <circle cx="15" cy="14" r="6" fill="white"/>
                            </svg>
                        `)
                    })
                })
            });
            
            // Add layer to map
            map.addLayer(vectorLayer);
            console.log('✓ Pin marker added at coordinates:', [x, y]);
        }
    </script>
</body>
</html>