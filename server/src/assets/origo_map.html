<!DOCTYPE html>
<html>
<head>
    <title>AMP Correlation Map - Origo Embed</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://stadsatlas.malmo.se/stadsatlas/css/style.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }
        #map {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <script src="https://stadsatlas.malmo.se/stadsatlas/js/origo.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ol@7.5.0/dist/ol.min.js"></script>
    <script>
        // Parse URL parameters
        const urlParams = new URLSearchParams(window.location.hash.substring(1));
        const centerStr = urlParams.get('center');
        const zoom = parseInt(urlParams.get('zoom')) || 18;
        
        let x = 120844;  // Default center
        let y = 6161226;
        
        // Parse center coordinates
        if (centerStr) {
            const coords = centerStr.split(',');
            if (coords.length === 2) {
                x = parseFloat(coords[0]);
                y = parseFloat(coords[1]);
            }
        }
        
        console.log('üó∫Ô∏è Origo Map Init - Center:', [x, y], 'Zoom:', zoom);
        
        // Initialize Origo with StadsAtlas config
        fetch('https://stadsatlas.malmo.se/stadsatlas/index.json')
            .then(response => response.json())
            .then(config => {
                console.log('üì° Loaded StadsAtlas config');
                
                // Create map
                window.map = o.create({
                    target: 'map',
                    ...config,
                    center: [x, y],
                    zoom: zoom,
                    resolutions: config.resolutions
                });
                
                // After a delay, enable layers using Origo's API
                setTimeout(() => {
                    console.log('‚úèÔ∏è Setting up layers via Origo API...');
                    
                    // Method 1: Toggle layers by name using Origo's toggleLayer API
                    try {
                        // Turn on Bakgrund layers
                        window.map.toggleLayer('Bakgrundskarta_nedtonad_3008_text');
                        console.log('‚úÖ Toggled Bakgrundskarta_nedtonad_3008_text');
                    } catch (e) {
                        console.log('üôà Bakgrund toggle failed:', e.message);
                    }
                    
                    try {
                        // Turn on milj√∂parkering layer
                        window.map.toggleLayer('miljoparkeringl');
                        console.log('‚úÖ Toggled miljoparkeringl');
                    } catch (e) {
                        console.log('üôà Milj√∂parkering toggle failed:', e.message);
                    }
                    
                    // Method 2: Try to access layers array and enable by visibility
                    const layers = window.map.getLayers().getArray();
                    console.log(`üìä Total layers: ${layers.length}`);
                    
                    layers.forEach((layer, idx) => {
                        const name = layer.get('name') || '';
                        
                        // Enable bakgrund
                        if (name.toLowerCase().includes('bakgrund')) {
                            layer.setVisible(true);
                            console.log(`‚úÖ Enabled layer[${idx}]: ${name}`);
                        }
                        
                        // Enable milj√∂parkering
                        if (name === 'miljoparkeringl') {
                            layer.setVisible(true);
                            console.log(`‚úÖ Enabled layer[${idx}]: ${name}`);
                        }
                    });
                    
                    // Add pin to map
                    addPinMarker(x, y);
                    
                }, 1000);  // Wait 1 second for map to fully initialize
            })
            .catch(error => {
                console.error('‚ùå Failed to load StadsAtlas config:', error);
            });
        
        // Function to add a pin marker
        function addPinMarker(x, y) {
            console.log('üìè Adding pin at:', [x, y]);
            
            const vectorSource = new ol.source.Vector({
                features: [
                    new ol.Feature({
                        geometry: new ol.geom.Point([x, y])
                    })
                ]
            });
            
            const vectorLayer = new ol.layer.Vector({
                source: vectorSource,
                zIndex: 9999,  // Ensure it appears on top
                style: new ol.style.Style({
                    image: new ol.style.Icon({
                        anchor: [0.5, 1],
                        anchorXUnits: 'fraction',
                        anchorYUnits: 'fraction',
                        scale: 1.2,
                        src: 'data:image/svg+xml;utf8,' + encodeURIComponent(`
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="44" viewBox="0 0 32 44">
                                <defs>
                                    <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">
                                        <feDropShadow dx="0" dy="2" stdDeviation="2" flood-opacity="0.3"/>
                                    </filter>
                                </defs>
                                <path d="M16 2 C9 2, 3 8, 3 16 C3 26, 16 44, 16 44 S29 26, 29 16 C29 8, 23 2, 16 2" 
                                      fill="#FF4444" stroke="white" stroke-width="2.5" filter="url(#shadow)"/>
                                <circle cx="16" cy="15" r="6" fill="white" stroke="#FF4444" stroke-width="1.5"/>
                            </svg>
                        `)
                    })
                })
            });
            
            // Add to map
            if (window.map) {
                window.map.addLayer(vectorLayer);
                console.log('‚úÖ Pin added to map');
            } else {
                console.error('‚ùå Map object not available');
            }
        }
    </script>
</body>
</html>