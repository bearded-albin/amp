<!DOCTYPE html>
<html>
<head>
    <title>AMP Correlation Map - Direct Origo Embed</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://stadsatlas.malmo.se/stadsatlas/css/style.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }
        #map {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <script src="https://stadsatlas.malmo.se/stadsatlas/js/origo.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ol@7.5.0/dist/ol.min.js"></script>
    <script>
        // Parse URL parameters
        const urlParams = new URLSearchParams(window.location.hash.substring(1));
        const centerStr = urlParams.get('center');
        const zoom = parseInt(urlParams.get('zoom')) || 18;
        
        let x = 120844;  // Default center
        let y = 6161226;
        
        // Parse center coordinates
        if (centerStr) {
            const coords = centerStr.split(',');
            if (coords.length === 2) {
                x = parseFloat(coords[0]);
                y = parseFloat(coords[1]);
            }
        }
        
        console.log('üó∫Ô∏è Origo Map Init - Center:', [x, y], 'Zoom:', zoom);
        
        // Initialize Origo with StadsAtlas config
        fetch('https://stadsatlas.malmo.se/stadsatlas/index.json')
            .then(response => response.json())
            .then(config => {
                console.log('üì° Loaded StadsAtlas config');
                
                // Create map with modified config
                const map = o.create({
                    target: 'map',
                    ...config,
                    center: [x, y],
                    zoom: zoom,
                    resolutions: config.resolutions
                });
                
                // After map initializes, set up layers and add pin
                map.on('load', function() {
                    console.log('‚úÖ Map loaded - setting up layers');
                    
                    // Get all layers
                    const allLayers = map.getLayers().getArray();
                    console.log(`üìä Total layers found: ${allLayers.length}`);
                    
                    // Log all layer names for debugging
                    allLayers.forEach((layer, idx) => {
                        const layerName = layer.get('name') || '';
                        const isVisible = layer.getVisible();
                        console.log(`  [${idx}] ${layerName} (visible: ${isVisible})`);
                    });
                    
                    // Enable background and milj√∂parkering layers
                    let bgEnabled = false;
                    let miljoEnabled = false;
                    
                    allLayers.forEach(layer => {
                        const layerName = (layer.get('name') || '').toLowerCase();
                        
                        // Show background layers
                        if (layerName.includes('bakgrund') || 
                            layerName.includes('background')) {
                            layer.setVisible(true);
                            bgEnabled = true;
                            console.log('‚úÖ Enabled background layer:', layer.get('name'));
                        }
                        
                        // Show milj√∂parkering layer (note: the actual name is 'miljoparkeringl')
                        if (layerName.includes('miljoparkering')) {
                            layer.setVisible(true);
                            miljoEnabled = true;
                            console.log('‚úÖ Enabled milj√∂parkering layer:', layer.get('name'));
                        }
                    });
                    
                    console.log('üìã Layer Status:', { bgEnabled, miljoEnabled });
                    
                    // Add pin marker at center
                    addPinMarker(map, x, y);
                    
                    console.log('üìç Pin marker added at:', [x, y]);
                });
                
                // Error handling
                map.on('error', function(error) {
                    console.error('‚ùå Map error:', error);
                });
            })
            .catch(error => {
                console.error('‚ùå Failed to load StadsAtlas config:', error);
            });
        
        // Function to add a pin marker using OpenLayers
        function addPinMarker(map, x, y) {
            // Create vector source for the marker
            const vectorSource = new ol.source.Vector({
                features: [
                    new ol.Feature({
                        geometry: new ol.geom.Point([x, y])
                    })
                ]
            });
            
            // Create vector layer with custom style
            const vectorLayer = new ol.layer.Vector({
                source: vectorSource,
                style: new ol.style.Style({
                    image: new ol.style.Icon({
                        anchor: [0.5, 1],
                        anchorXUnits: 'fraction',
                        anchorYUnits: 'fraction',
                        scale: 1.2,
                        src: 'data:image/svg+xml;utf8,' + encodeURIComponent(`
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="44" viewBox="0 0 32 44">
                                <!-- Pin shadow -->
                                <defs>
                                    <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">
                                        <feDropShadow dx="0" dy="2" stdDeviation="2" flood-opacity="0.3"/>
                                    </filter>
                                </defs>
                                <!-- Pin body -->
                                <path d="M16 2 C9 2, 3 8, 3 16 C3 26, 16 44, 16 44 S29 26, 29 16 C29 8, 23 2, 16 2" 
                                      fill="#FF4444" stroke="white" stroke-width="2.5" filter="url(#shadow)"/>
                                <!-- Pin center circle -->
                                <circle cx="16" cy="15" r="6" fill="white" stroke="#FF4444" stroke-width="1.5"/>
                            </svg>
                        `)
                    })
                })
            });
            
            // Add layer to map (add it last so it appears on top)
            map.addLayer(vectorLayer);
        }
    </script>
</body>
</html>